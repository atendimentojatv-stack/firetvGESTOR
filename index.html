<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIRE TV - Gestor IPTV</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel para React -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map -->
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.2.0",
        "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
        "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
        "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
        "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
        "lucide-react": "https://esm.sh/lucide-react@0.263.1"
      }
    }
    </script>
</head>
<body class="bg-slate-950 text-white">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { initializeApp } from 'firebase/app';
        import { 
          getAuth, 
          signInWithEmailAndPassword,
          createUserWithEmailAndPassword,
          signOut,
          onAuthStateChanged,
          signInAnonymously
        } from 'firebase/auth';
        import { 
          getFirestore, 
          collection, 
          addDoc, 
          query, 
          where, 
          onSnapshot, 
          doc, 
          updateDoc, 
          deleteDoc,
          serverTimestamp,
          getDocs,
          setDoc
        } from 'firebase/firestore';
        import { 
          Tv, LayoutDashboard, LogOut, Plus, Search, UserPlus, Shield, 
          Trash2, Edit, CheckCircle, XCircle, Calendar, Zap, TrendingUp, 
          Smartphone, Globe, Settings, RefreshCw, MessageCircle, Filter, 
          AlertTriangle, DollarSign, Lock, Unlock, Eye, EyeOff, Clock
        } from 'lucide-react';

        // --- CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyClcK67ZPEC-4uky5y6RIYCyKF4BqO3xcE",
          authDomain: "firetv-gestor.firebaseapp.com",
          projectId: "firetv-gestor",
          storageBucket: "firetv-gestor.firebasestorage.app",
          messagingSenderId: "345143716576",
          appId: "1:345143716576:web:bc9837700de2dc21a8fe85"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const ARTIFACTS_COLLECTION = 'firetv_production_db'; 

        // --- UTILIT√ÅRIOS ---
        const formatDate = (val) => {
          if (!val) return '-';
          // Se for timestamp do Firestore ou n√∫mero
          const date = typeof val === 'object' && val.toDate ? val.toDate() : new Date(val); 
          if (isNaN(date.getTime())) return '-'; // Data inv√°lida
          return new Intl.DateTimeFormat('pt-BR').format(date);
        };

        const getDaysLeft = (expirationDate) => {
            if (!expirationDate) return 0;
            const end = typeof expirationDate === 'object' && expirationDate.toDate ? expirationDate.toDate() : new Date(expirationDate);
            const now = new Date();
            const diff = end - now;
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        };

        const getClientStatus = (dueDate) => {
          if (!dueDate) return { status: 'no_date', label: 'Sem Data', color: 'slate' };
          const today = new Date(); today.setHours(0, 0, 0, 0);
          const due = new Date(dueDate + 'T12:00:00'); due.setHours(0, 0, 0, 0);
          const diffTime = due - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

          if (diffDays < 0) return { status: 'expired', label: 'Vencido', color: 'red', days: diffDays };
          if (diffDays === 0) return { status: 'today', label: 'Vence Hoje', color: 'orange', days: 0 };
          if (diffDays <= 3) return { status: 'expiring', label: `Vence em ${diffDays}d`, color: 'yellow', days: diffDays };
          return { status: 'active', label: 'Ativo', color: 'green', days: diffDays };
        };

        // --- COMPONENTES ---

        const LandingPage = ({ onLogin, onRegister }) => (
          <div className="min-h-screen bg-slate-950 text-white font-sans selection:bg-orange-500 selection:text-white">
              <nav className="container mx-auto px-6 py-4 flex justify-between items-center z-20 relative">
                <div className="flex items-center gap-2">
                  <div className="bg-gradient-to-br from-orange-500 to-red-600 p-2 rounded-lg"><Tv size={24} className="text-white" /></div>
                  <span className="text-2xl font-bold tracking-tighter">FIRE <span className="text-orange-500">TV</span></span>
                </div>
                <button onClick={onLogin} className="text-slate-300 hover:text-white font-medium transition-colors">√Årea do Cliente</button>
              </nav>
              <div className="relative pt-16 pb-32 flex content-center items-center justify-center min-h-[85vh]">
                <div className="absolute top-0 w-full h-full bg-center bg-cover opacity-20" style={{ backgroundImage: "url('https://images.unsplash.com/photo-1593784991095-a20506948430?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80')" }}></div>
                <div className="container relative mx-auto px-4 text-center z-10">
                  <div className="inline-block mb-4 px-4 py-1 rounded-full bg-orange-500/10 border border-orange-500/30 text-orange-400 font-semibold text-sm animate-pulse">üöÄ O Melhor Gestor para Revendas</div>
                  <h1 className="text-5xl md:text-7xl font-extrabold leading-tight mb-6">Gerencie sua <span className="text-transparent bg-clip-text bg-gradient-to-r from-orange-400 to-red-600">Revenda IPTV</span></h1>
                  <div className="flex flex-col sm:flex-row justify-center gap-4">
                    <button onClick={onRegister} className="px-8 py-4 bg-gradient-to-r from-orange-500 to-red-600 rounded-xl font-bold text-lg shadow-lg shadow-orange-500/30 hover:scale-105 transition-transform flex items-center justify-center gap-2"><Zap size={20} /> Teste Gr√°tis (7 Dias)</button>
                    <button onClick={onLogin} className="px-8 py-4 bg-slate-800 border border-slate-700 rounded-xl font-bold text-lg hover:bg-slate-700 transition-colors">J√° tenho conta</button>
                  </div>
                </div>
              </div>
          </div>
        );

        const AuthModal = ({ isOpen, onClose, type, onAuthSuccess }) => {
          const [email, setEmail] = useState('');
          const [password, setPassword] = useState('');
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState('');
          const [showPassword, setShowPassword] = useState(false);

          if (!isOpen) return null;

          const handleAuth = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');

            try {
              if (type === 'register') {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                const q = query(collection(db, ARTIFACTS_COLLECTION, 'data', 'users'), where('email', '==', email));
                const querySnapshot = await getDocs(q);

                let userData = {};

                // Define data de expira√ß√£o do PAINEL
                const isCeo = email === 'admin@firetv.com';
                const daysToAdd = isCeo ? 3650 : 7; // CEO = 10 anos, Teste = 7 dias
                const expirationDate = new Date();
                expirationDate.setDate(expirationDate.getDate() + daysToAdd);

                if (!querySnapshot.empty) {
                  // Usu√°rio j√° foi convidado pelo CEO/Master (j√° tem plano definido pelo chefe)
                  const existingDoc = querySnapshot.docs[0];
                  const existingData = existingDoc.data();
                  
                  await setDoc(doc(db, ARTIFACTS_COLLECTION, 'data', 'users', existingDoc.id), {
                    ...existingData,
                    uid: user.uid,
                    lastLogin: serverTimestamp()
                  }, { merge: true });
                  userData = existingData;
                  
                } else {
                  // Novo Cadastro pelo Site (Teste Gr√°tis)
                  userData = {
                    uid: user.uid,
                    email: email,
                    role: isCeo ? 'ceo' : 'reseller',
                    parentId: 'system',
                    createdAt: serverTimestamp(),
                    name: email.split('@')[0],
                    status: 'active',
                    plan: isCeo ? 'unlimited' : 'trial',
                    panelExpiration: expirationDate.toISOString(), // DATA DE VENCIMENTO DO PAINEL
                    credits: 0 // Teste gr√°tis come√ßa zerado ou com 1 cr√©dito de cortesia se quiser
                  };
                  await addDoc(collection(db, ARTIFACTS_COLLECTION, 'data', 'users'), userData);
                }
                onAuthSuccess(userData);
              } else {
                await signInWithEmailAndPassword(auth, email, password);
                onClose();
              }
            } catch (err) {
              console.error(err);
              let msg = "Erro na autentica√ß√£o.";
              if (err.code === 'auth/email-already-in-use') msg = "E-mail j√° cadastrado.";
              if (err.code === 'auth/invalid-login-credentials') msg = "E-mail ou senha incorretos.";
              setError(msg);
            } finally {
              setLoading(false);
            }
          };

          return (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
              <div className="bg-slate-900 border border-slate-800 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-2xl font-bold text-white">{type === 'login' ? 'Acessar Painel' : 'Criar Conta'}</h2>
                  <button onClick={onClose}><XCircle size={24} className="text-slate-400 hover:text-white"/></button>
                </div>
                {error && <div className="bg-red-500/10 border border-red-500/50 text-red-200 p-3 rounded-lg mb-4 text-sm">{error}</div>}
                <form onSubmit={handleAuth} className="space-y-4">
                  <div><label className="text-xs text-slate-400 ml-1">E-mail</label><input type="email" required value={email} onChange={(e) => setEmail(e.target.value)} className="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white focus:border-orange-500 outline-none" placeholder="seu@email.com"/></div>
                  <div className="relative">
                     <label className="text-xs text-slate-400 ml-1">Senha</label>
                     <input type={showPassword ? "text" : "password"} required value={password} onChange={(e) => setPassword(e.target.value)} className="w-full bg-slate-950 border border-slate-800 rounded-lg p-3 text-white focus:border-orange-500 outline-none" placeholder="******" minLength={6}/>
                     <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-8 text-slate-500 hover:text-white">{showPassword ? <EyeOff size={18}/> : <Eye size={18}/>}</button>
                  </div>
                  <button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-orange-500 to-red-600 text-white font-bold py-3 rounded-lg hover:opacity-90 transition-opacity">{loading ? 'Processando...' : (type === 'login' ? 'Entrar' : 'Confirmar')}</button>
                </form>
              </div>
            </div>
          );
        };

        const ToastNotification = ({ notification, onClose }) => {
          if (!notification.show) return null;
          useEffect(() => { const t = setTimeout(onClose, 3000); return () => clearTimeout(t); }, [notification, onClose]);
          return (
            <div className={`fixed bottom-4 right-4 z-[60] flex items-center gap-3 px-4 py-3 rounded-lg shadow-2xl border animate-in slide-in-from-right duration-300 ${notification.type === 'success' ? 'bg-slate-900 border-green-500/50 text-green-400' : 'bg-slate-900 border-red-500/50 text-red-400'}`}>
              {notification.type === 'success' ? <CheckCircle size={20} /> : <AlertTriangle size={20} />}
              <p className="font-medium text-sm text-white">{notification.message}</p>
            </div>
          );
        };

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel, isLoading }) => {
          if (!isOpen) return null;
          return (
            <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-[70] flex items-center justify-center p-4">
              <div className="bg-slate-900 border border-slate-700 w-full max-w-sm rounded-xl p-6 shadow-2xl">
                <h3 className="text-xl font-bold text-white mb-2">{title}</h3>
                <p className="text-slate-400 mb-6">{message}</p>
                <div className="flex gap-3 justify-end">
                  <button onClick={onCancel} disabled={isLoading} className="px-4 py-2 rounded-lg text-slate-300 hover:bg-slate-800">Cancelar</button>
                  <button onClick={onConfirm} disabled={isLoading} className="px-4 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold">{isLoading ? '...' : 'Confirmar'}</button>
                </div>
              </div>
            </div>
          );
        };

        // --- APP PRINCIPAL ---
        const FireTVManager = () => {
          const [user, setUser] = useState(null);
          const [view, setView] = useState('landing');
          const [activeTab, setActiveTab] = useState('dashboard');
          const [showAuthModal, setShowAuthModal] = useState(false);
          const [authType, setAuthType] = useState('login');
          const [clients, setClients] = useState([]);
          const [team, setTeam] = useState([]);
          const [allResellersCount, setAllResellersCount] = useState(0);
          const [initializing, setInitializing] = useState(true);
          const [filterStatus, setFilterStatus] = useState('all');
          const [searchTerm, setSearchTerm] = useState('');
          const [isAddModalOpen, setIsAddModalOpen] = useState(false);
          const [modalType, setModalType] = useState('client'); 
          const [editingItem, setEditingItem] = useState(null); 
          const [formData, setFormData] = useState({});
          const [notification, setNotification] = useState({ show: false, message: '', type: 'success' });
          const [confirmDialog, setConfirmDialog] = useState({ isOpen: false, title: '', message: '', onConfirm: null });
          const [isProcessing, setIsProcessing] = useState(false);
          const [teamFilter, setTeamFilter] = useState('master'); // Novo filtro para o CEO (master ou reseller)

          const showToast = (message, type = 'success') => setNotification({ show: true, message, type });

          useEffect(() => {
            const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
              if (currentUser) {
                const q = query(collection(db, ARTIFACTS_COLLECTION, 'data', 'users'), where('email', '==', currentUser.email));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const userDoc = snapshot.docs[0];
                    const uData = { id: userDoc.id, ...userDoc.data() };
                    // Verifica expira√ß√£o do painel ao logar
                    const daysLeft = getDaysLeft(uData.panelExpiration);
                    // Se n√£o for CEO e estiver vencido, poderia bloquear aqui
                    setUser(uData);
                    setView('dashboard');
                } else {
                     // Fallback
                     setUser(null);
                     setView('landing');
                }
              } else {
                setUser(null);
                setView('landing');
              }
              setInitializing(false);
            });
            return () => unsubscribe();
          }, []);

          // FETCH DE DADOS
          useEffect(() => {
            if (!user || view !== 'dashboard') return;
            
            // Meus Clientes
            const qClients = query(collection(db, ARTIFACTS_COLLECTION, 'data', 'clients'), where('createdBy', '==', user.email));
            const unsubscribeClients = onSnapshot(qClients, (snapshot) => {
                setClients(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            });

            let unsubscribeTeam = () => {};
            
            if (user.role === 'ceo') {
                // CEO: V√™ tudo com base no filtro (teamFilter)
                // Se filtro for 'master', busca masters. Se for 'reseller', busca todos os revendedores (incluindo trials)
                let roleToFetch = teamFilter;
                const qTeam = query(collection(db, ARTIFACTS_COLLECTION, 'data', 'users'), where('role', '==', roleToFetch));
                unsubscribeTeam = onSnapshot(qTeam, (snapshot) => setTeam(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
                
                // Count total revendas
                const qAll = query(collection(db, ARTIFACTS_COLLECTION, 'data', 'users'), where('role', '==', 'reseller'));
                getDocs(qAll).then(s => setAllResellersCount(s.size));

            } else if (user.role === 'master') {
                const qTeam = query(collection(db, ARTIFACTS_COLLECTION, 'data', 'users'), where('role', '==', 'reseller'), where('parentId', '==', user.email));
                unsubscribeTeam = onSnapshot(qTeam, (snapshot) => setTeam(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))));
            }
            return () => { unsubscribeClients(); unsubscribeTeam(); };
          }, [user, view, teamFilter]); // Atualiza quando o CEO muda o filtro

          const handleLogout = async () => await signOut(auth);

          const openAddModal = (type, itemToEdit = null) => {
            setModalType(type);
            setEditingItem(itemToEdit);
            setFormData(itemToEdit ? { ...itemToEdit } : {});
            setIsAddModalOpen(true);
          };

          const handleSaveItem = async (e) => {
            e.preventDefault();
            try {
                if (modalType === 'client') {
                    // REGRA DE CR√âDITO: Verificar se tem cr√©dito antes de criar cliente
                    if (!editingItem && user.role !== 'ceo') { // CEO n√£o gasta cr√©dito
                        if ((user.credits || 0) < 1) {
                            throw new Error("Voc√™ n√£o tem cr√©ditos suficientes! Contate seu Master.");
                        }
                        // Deduzir cr√©dito localmente para feedback r√°pido (O ideal seria Cloud Function)
                        await updateDoc(doc(db, ARTIFACTS_COLLECTION, 'data', 'users', user.id), {
                            credits: (user.credits || 0) - 1
                        });
                        // Atualiza estado local
                        setUser(prev => ({...prev, credits: (prev.credits || 0) - 1}));
                    }

                    if (editingItem) {
                        await updateDoc(doc(db, ARTIFACTS_COLLECTION, 'data', 'clients', editingItem.id), { ...formData });
                        showToast('Cliente atualizado!');
                    } else {
                        await addDoc(collection(db, ARTIFACTS_COLLECTION, 'data', 'clients'), {
                            ...formData, createdBy: user.email, createdAt: new Date().toISOString(), status: 'active'
                        });
                        showToast('Cliente cadastrado! (-1 Cr√©dito)');
                    }
                } else {
                    // Criar/Editar Usu√°rio (Equipe)
                    if (editingItem) {
                        await updateDoc(doc(db, ARTIFACTS_COLLECTION, 'data', 'users', editingItem.id), { ...formData, credits: Number(formData.credits) });
                        showToast('Dados atualizados!');
                    } else {
                        // Criar NOVO
                        const newRole = user.role === 'ceo' ? 'master' : 'reseller';
                        // Data de validade padr√£o: 30 dias para criados manualmente
                        const expDate = new Date();
                        expDate.setDate(expDate.getDate() + 30);

                        await addDoc(collection(db, ARTIFACTS_COLLECTION, 'data', 'users'), {
                            ...formData,
                            role: newRole,
                            parentId: user.email,
                            createdAt: serverTimestamp(),
                            status: 'active',
                            credits: Number(formData.credits) || 0,
                            panelExpiration: expDate.toISOString(),
                            isInvite: true
                        });
                        showToast('Usu√°rio criado! Pe√ßa para ele se registrar.');
                    }
                }
                setIsAddModalOpen(false);
                setFormData({});
                setEditingItem(null);
            } catch (error) { showToast("Erro: " + error.message, 'error'); }
          };

          // Renovar PAINEL do Revendedor (A√ß√£o do CEO/Master)
          const handleRenewPanel = (targetUser) => {
             setConfirmDialog({
                isOpen: true, title: 'Renovar Painel da Revenda', message: `Adicionar 30 dias de acesso para ${targetUser.name}?`,
                onConfirm: async () => {
                    setIsProcessing(true);
                    try {
                        let currentExp = targetUser.panelExpiration ? new Date(targetUser.panelExpiration) : new Date();
                        if (currentExp < new Date()) currentExp = new Date(); // Se venceu, renova de hoje
                        currentExp.setDate(currentExp.getDate() + 30);
                        
                        await updateDoc(doc(db, ARTIFACTS_COLLECTION, 'data', 'users', targetUser.id), {
                            panelExpiration: currentExp.toISOString(),
                            plan: 'renewed' // Remove flag de trial se tiver
                        });
                        showToast('Painel renovado com sucesso!');
                        setConfirmDialog({ isOpen: false });
                    } catch(err) { showToast('Erro: ' + err.message, 'error'); } finally { setIsProcessing(false); }
                }
            });
          };

          const handleRenewClient = (client) => {
            setConfirmDialog({
                isOpen: true, title: 'Renovar Cliente', message: `Adicionar 30 dias para ${client.name}? (Custa 1 Cr√©dito)`,
                onConfirm: async () => {
                    if (user.role !== 'ceo' && (user.credits || 0) < 1) {
                        showToast('Sem cr√©ditos para renovar!', 'error');
                        setConfirmDialog({ isOpen: false });
                        return;
                    }
                    setIsProcessing(true);
                    try {
                        // Deduz cr√©dito
                        if (user.role !== 'ceo') {
                            await updateDoc(doc(db, ARTIFACTS_COLLECTION, 'data', 'users', user.id), { credits: (user.credits || 0) - 1 });
                            setUser(prev => ({...prev, credits: (prev.credits || 0) - 1}));
                        }

                        let baseDate = new Date();
                        const currentDueStr = client.dueDate; 
                        if (currentDueStr) {
                             const currentDue = new Date(currentDueStr + 'T12:00:00');
                             if (currentDue > baseDate) baseDate = currentDue;
                        }
                        baseDate.setDate(baseDate.getDate() + 30);
                        const newDateStr = baseDate.toISOString().split('T')[0];
                        await updateDoc(doc(db, ARTIFACTS_COLLECTION, 'data', 'clients', client.id), { dueDate: newDateStr, status: 'active' });
                        showToast(`Renovado! (-1 Cr√©dito)`);
                        setConfirmDialog({ isOpen: false });
                    } catch (err) { showToast('Erro: ' + err.message, 'error'); } finally { setIsProcessing(false); }
                }
            });
          };

          // Filtros de Clientes
          const filteredClients = useMemo(() => {
              return clients.filter(client => {
                  const matchText = client.name?.toLowerCase().includes(searchTerm.toLowerCase()) || client.whatsapp?.includes(searchTerm);
                  if (!matchText) return false;
                  const { status } = getClientStatus(client.dueDate);
                  if (filterStatus === 'all') return true;
                  if (filterStatus === 'active') return status === 'active' || status === 'expiring' || status === 'today';
                  if (filterStatus === 'expired') return status === 'expired';
                  if (filterStatus === 'expiring') return status === 'expiring' || status === 'today';
                  return true;
              }).sort((a, b) => new Date(a.dueDate || '2099-01-01') - new Date(b.dueDate || '2099-01-01'));
          }, [clients, searchTerm, filterStatus]);

          // Badges
          const RoleBadge = ({ role }) => {
              const styles = { ceo: 'bg-red-500/20 text-red-400 border-red-500/30', master: 'bg-purple-500/20 text-purple-400 border-purple-500/30', reseller: 'bg-blue-500/20 text-blue-400 border-blue-500/30' };
              const labels = { ceo: 'CEO', master: 'MASTER', reseller: 'REVENDA' };
              return <span className={`px-2 py-0.5 rounded text-xs font-bold border ${styles[role] || styles.reseller}`}>{labels[role]}</span>;
          };

          if (initializing) return <div className="h-screen bg-slate-950 flex items-center justify-center text-orange-500 font-bold animate-pulse">Carregando Fire TV...</div>;

          // DADOS DO USU√ÅRIO LOGADO (Vencimento do Painel)
          const myDaysLeft = getDaysLeft(user?.panelExpiration);
          const isTrial = user?.plan === 'trial';

          return (
            <>
              <ToastNotification notification={notification} onClose={() => setNotification({...notification, show: false})} />
              <ConfirmDialog isOpen={confirmDialog.isOpen} title={confirmDialog.title} message={confirmDialog.message} onConfirm={confirmDialog.onConfirm} onCancel={() => setConfirmDialog({...confirmDialog, isOpen: false})} isLoading={isProcessing} />
              
              {showAuthModal && <AuthModal isOpen={showAuthModal} onClose={() => setShowAuthModal(false)} type={authType} onAuthSuccess={userData => { setUser(userData); setView('dashboard'); setShowAuthModal(false); }} />}

              {view === 'landing' ? (
                <LandingPage onLogin={() => { setAuthType('login'); setShowAuthModal(true); }} onRegister={() => { setAuthType('register'); setShowAuthModal(true); }} />
              ) : (
                <div className="flex h-screen bg-slate-950 text-white overflow-hidden font-sans">
                  <aside className="w-64 bg-slate-900 border-r border-slate-800 hidden md:flex flex-col">
                    <div className="p-6 border-b border-slate-800 flex items-center gap-2">
                        <div className="bg-gradient-to-br from-orange-500 to-red-600 p-1.5 rounded"><Tv size={20} className="text-white" /></div>
                        <span className="text-xl font-bold tracking-tight">FIRE <span className="text-orange-500">TV</span></span>
                    </div>
                    
                    {/* BANNER DE VENCIMENTO LATERAL */}
                    <div className={`mx-4 mt-4 p-3 rounded-lg border ${isTrial ? 'bg-yellow-500/10 border-yellow-500/30 text-yellow-400' : myDaysLeft < 5 ? 'bg-red-500/10 border-red-500/30 text-red-400' : 'bg-slate-800 border-slate-700 text-slate-300'}`}>
                        <div className="flex items-center gap-2 mb-1">
                            <Clock size={16} />
                            <span className="text-xs font-bold uppercase">{isTrial ? 'Modo Teste' : 'Seu Painel'}</span>
                        </div>
                        <div className="text-sm font-medium">
                            {myDaysLeft > 0 ? `Expira em ${myDaysLeft} dias` : 'Painel Vencido!'}
                        </div>
                    </div>

                    <div className="p-4 flex-1 space-y-2">
                        <button onClick={() => setActiveTab('dashboard')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'dashboard' ? 'bg-orange-500/10 text-orange-500 border border-orange-500/20' : 'text-slate-400 hover:bg-slate-800'}`}><LayoutDashboard size={20} /> In√≠cio</button>
                        <button onClick={() => setActiveTab('clients')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'clients' ? 'bg-orange-500/10 text-orange-500 border border-orange-500/20' : 'text-slate-400 hover:bg-slate-800'}`}><UserPlus size={20} /> Meus Clientes</button>
                        {user.role !== 'reseller' && <button onClick={() => setActiveTab('team')} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg transition-all ${activeTab === 'team' ? 'bg-orange-500/10 text-orange-500 border border-orange-500/20' : 'text-slate-400 hover:bg-slate-800'}`}><Shield size={20} /> {user.role === 'ceo' ? 'Gerir Equipe' : 'Minhas Revendas'}</button>}
                    </div>
                    <div className="p-4 border-t border-slate-800">
                        <div className="flex items-center gap-3 mb-4 px-2">
                            <div className="w-8 h-8 rounded-full bg-gradient-to-r from-slate-700 to-slate-600 flex items-center justify-center text-xs font-bold">{user.name?.charAt(0).toUpperCase()}</div>
                            <div className="flex-1 min-w-0">
                                <p className="text-sm font-medium truncate">{user.name}</p>
                                <div className="flex items-center gap-2">
                                    <RoleBadge role={user.role} />
                                    {user.role !== 'ceo' && <span className="text-xs text-yellow-500 font-bold flex items-center">üíé {user.credits || 0}</span>}
                                </div>
                            </div>
                        </div>
                        <button onClick={handleLogout} className="w-full flex items-center justify-center gap-2 text-red-400 hover:bg-red-500/10 p-2 rounded-lg text-sm"><LogOut size={16} /> Sair</button>
                    </div>
                  </aside>

                  <main className="flex-1 overflow-y-auto p-4 md:p-8 pt-20 md:pt-8 relative">
                    <header className="flex justify-between items-center mb-8">
                        <div>
                            <h1 className="text-2xl font-bold text-white">{activeTab === 'dashboard' ? 'Vis√£o Geral' : activeTab === 'clients' ? 'Gest√£o de Clientes' : 'Gerenciamento de Equipe'}</h1>
                            <p className="text-slate-400 text-sm">
                                {user.role !== 'ceo' ? `Cr√©ditos Dispon√≠veis: ${user.credits || 0}` : `Painel Administrativo`}
                            </p>
                        </div>
                        <div className="flex gap-2">
                            {(activeTab === 'clients' || activeTab === 'team') && (
                                <button onClick={() => openAddModal(activeTab === 'clients' ? 'client' : 'user')} className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 font-medium shadow-lg shadow-orange-500/20"><Plus size={18} /> Novo {activeTab === 'clients' ? 'Cliente' : (user.role === 'ceo' ? 'Membro' : 'Revenda')}</button>
                            )}
                        </div>
                    </header>

                    {/* DASHBOARD */}
                    {activeTab === 'dashboard' && (
                        <div className="space-y-6">
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                                <StatCard title="Total Clientes" value={clients.length} icon={<UserPlus size={24} />} color="blue" />
                                <StatCard title="Vencidos" value={clients.filter(c => getClientStatus(c.dueDate).status === 'expired').length} icon={<AlertTriangle size={24} />} color="red" />
                                <StatCard title="Vence Hoje" value={clients.filter(c => getClientStatus(c.dueDate).status === 'today').length} icon={<Calendar size={24} />} color="orange" />
                                {user.role === 'ceo' && <StatCard title="Total Revendas" value={allResellersCount} icon={<Globe size={24} />} color="green" />}
                                {user.role !== 'ceo' && <StatCard title="Meus Cr√©ditos" value={user.credits || 0} icon={<DollarSign size={24} />} color="yellow" />}
                            </div>
                            <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                                <div className="p-6 border-b border-slate-800"><h3 className="font-bold">Pr√≥ximos Vencimentos (Clientes)</h3></div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-sm text-slate-400">
                                        <thead className="bg-slate-950 text-slate-300 uppercase text-xs"><tr><th className="px-6 py-3">Nome</th><th className="px-6 py-3">Vencimento</th><th className="px-6 py-3">Status</th><th className="px-6 py-3 text-right">A√ß√£o</th></tr></thead>
                                        <tbody>
                                            {clients.filter(c => ['expired','today','expiring'].includes(getClientStatus(c.dueDate).status)).slice(0, 5).map(client => {
                                                    const { label, color } = getClientStatus(client.dueDate);
                                                    return <tr key={client.id} className="border-b border-slate-800 hover:bg-slate-800/50"><td className="px-6 py-4 font-medium text-white">{client.name}</td><td className="px-6 py-4">{formatDate(client.dueDate)}</td><td className="px-6 py-4"><span className={`bg-${color}-500/20 text-${color}-400 px-2 py-1 rounded text-xs font-bold`}>{label}</span></td><td className="px-6 py-4 text-right"><button onClick={() => handleRenewClient(client)} className="p-1.5 bg-green-600 text-white rounded hover:bg-green-500"><RefreshCw size={14} /></button></td></tr>
                                            })}
                                            {clients.length === 0 && <tr><td colSpan="4" className="px-6 py-8 text-center">Nenhum cliente para mostrar.</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* CLIENTES */}
                    {activeTab === 'clients' && (
                        <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden flex flex-col h-[calc(100vh-180px)]">
                            <div className="p-4 border-b border-slate-800 flex flex-col md:flex-row gap-4 justify-between items-center bg-slate-900/50">
                                <div className="relative w-full md:w-1/3"><Search className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500" size={18} /><input type="text" value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} placeholder="Buscar cliente..." className="w-full bg-slate-950 border border-slate-800 rounded-lg py-2 pl-10 text-white focus:border-orange-500 outline-none" /></div>
                                <div className="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">{[{ id: 'all', label: 'Todos' }, { id: 'active', label: 'Ativos' }, { id: 'expired', label: 'Vencidos' }, { id: 'expiring', label: 'Vencendo' }].map(f => (<button key={f.id} onClick={() => setFilterStatus(f.id)} className={`px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap transition-all ${filterStatus === f.id ? 'bg-orange-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'}`}>{f.label}</button>))}</div>
                            </div>
                            <div className="overflow-auto flex-1">
                                <table className="w-full text-left text-sm text-slate-400">
                                    <thead className="bg-slate-950 text-slate-300 uppercase text-xs sticky top-0 z-10 shadow-sm"><tr><th className="px-6 py-3 bg-slate-950">Cliente</th><th className="px-6 py-3 bg-slate-950">Vencimento</th><th className="px-6 py-3 bg-slate-950">Status</th><th className="px-6 py-3 bg-slate-950 text-right">A√ß√µes</th></tr></thead>
                                    <tbody className="divide-y divide-slate-800">
                                        {filteredClients.map(client => {
                                            const { label, color } = getClientStatus(client.dueDate);
                                            const waLink = generateWhatsAppLink(client);
                                            return (
                                            <tr key={client.id} className="hover:bg-slate-800/30 transition-colors group">
                                                <td className="px-6 py-4"><div className="flex items-center gap-3"><div className={`w-2 h-10 rounded-full bg-${color}-500`}></div><div><p className="font-bold text-white text-base">{client.name}</p><p className="text-xs text-slate-500">{client.username || 'Sem usu√°rio'}</p></div></div></td>
                                                <td className="px-6 py-4"><div className="flex flex-col"><span className="text-slate-300 font-medium">{formatDate(client.dueDate)}</span></div></td>
                                                <td className="px-6 py-4"><span className={`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-bold bg-${color}-500/10 text-${color}-400 border border-${color}-500/20`}><div className={`w-1.5 h-1.5 rounded-full bg-${color}-500 animate-pulse`}></div>{label}</span></td>
                                                <td className="px-6 py-4 text-right"><div className="flex items-center justify-end gap-2 opacity-80 group-hover:opacity-100">{waLink && <a href={waLink} target="_blank" rel="noopener noreferrer" className="p-2 bg-green-600/20 text-green-400 hover:bg-green-600 hover:text-white rounded-lg"><MessageCircle size={18} /></a>}<button onClick={() => handleRenewClient(client)} className="p-2 bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white rounded-lg" title="Renovar (1 Cr√©dito)"><RefreshCw size={18} /></button><button onClick={() => openAddModal('client', client)} className="p-2 bg-slate-700 text-slate-300 hover:bg-slate-600 hover:text-white rounded-lg"><Edit size={18} /></button><button onClick={() => handleDeleteClient(client.id)} className="p-2 bg-red-600/10 text-red-400 hover:bg-red-600 hover:text-white rounded-lg"><Trash2 size={18} /></button></div></td>
                                            </tr>
                                        )})}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* EQUIPE (CEO E MASTER) */}
                    {activeTab === 'team' && (
                        <div className="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden">
                            <div className="p-6 border-b border-slate-800 flex justify-between items-center">
                                <h3 className="font-bold text-white">Gerenciamento de Equipe</h3>
                                {user.role === 'ceo' && (
                                    <div className="flex bg-slate-800 rounded-lg p-1">
                                        <button onClick={() => setTeamFilter('master')} className={`px-4 py-1 rounded-md text-xs font-bold transition-colors ${teamFilter === 'master' ? 'bg-purple-600 text-white' : 'text-slate-400 hover:text-white'}`}>Masters</button>
                                        <button onClick={() => setTeamFilter('reseller')} className={`px-4 py-1 rounded-md text-xs font-bold transition-colors ${teamFilter === 'reseller' ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}>Revendas/Trials</button>
                                    </div>
                                )}
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-left text-sm text-slate-400">
                                    <thead className="bg-slate-950 text-slate-300 uppercase text-xs"><tr><th className="px-6 py-3">Nome/Email</th><th className="px-6 py-3">Fun√ß√£o</th><th className="px-6 py-3">Cr√©ditos</th><th className="px-6 py-3">Painel Expira Em</th><th className="px-6 py-3 text-right">A√ß√µes</th></tr></thead>
                                    <tbody>
                                        {team.map(member => {
                                            const daysLeft = getDaysLeft(member.panelExpiration);
                                            const isTrial = member.plan === 'trial';
                                            return (
                                            <tr key={member.id} className="border-b border-slate-800 hover:bg-slate-800/50">
                                                <td className="px-6 py-4 font-medium text-white">
                                                    {member.email}
                                                    {isTrial && <span className="ml-2 text-[10px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded border border-yellow-500/30">TESTE</span>}
                                                </td>
                                                <td className="px-6 py-4"><RoleBadge role={member.role} /></td>
                                                <td className="px-6 py-4"><span className="text-yellow-500 font-bold flex items-center gap-1"><DollarSign size={14}/> {member.credits || 0}</span></td>
                                                <td className="px-6 py-4">
                                                    <span className={`font-bold ${daysLeft < 5 ? 'text-red-400' : 'text-green-400'}`}>
                                                        {daysLeft} Dias
                                                    </span>
                                                </td>
                                                <td className="px-6 py-4 text-right">
                                                    <div className="flex items-center justify-end gap-2">
                                                        <button onClick={() => handleRenewPanel(member)} className="p-2 bg-green-600/20 text-green-400 hover:bg-green-600 hover:text-white rounded-lg transition-colors" title="Renovar Painel (+30 Dias)"><RefreshCw size={16} /></button>
                                                        <button onClick={() => openAddModal('user', member)} className="p-2 bg-slate-700 text-slate-300 hover:bg-white hover:text-slate-900 rounded-lg transition-colors" title="Editar / Adicionar Cr√©ditos"><Edit size={16} /></button>
                                                        <button onClick={() => handleDeleteUser(member.id)} className="p-2 bg-red-600/10 text-red-400 hover:bg-red-600 hover:text-white rounded-lg transition-colors" title="Excluir"><Trash2 size={16} /></button>
                                                    </div>
                                                </td>
                                            </tr>
                                        )})}
                                        {team.length === 0 && <tr><td colSpan="5" className="px-6 py-12 text-center">Nenhum usu√°rio encontrado.</td></tr>}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* MODAIS */}
                    {isAddModalOpen && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                            <div className="bg-slate-900 border border-slate-800 w-full max-w-md rounded-2xl p-6 shadow-2xl">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold text-white">{modalType === 'client' ? (editingItem ? 'Editar Cliente' : 'Novo Cliente') : (editingItem ? 'Editar Revenda/Master' : 'Novo Membro')}</h2>
                                    <button onClick={() => setIsAddModalOpen(false)}><XCircle size={24} className="text-slate-400 hover:text-white"/></button>
                                </div>
                                <form onSubmit={handleSaveItem} className="space-y-4">
                                    {modalType === 'client' ? (
                                        <>
                                            <div><label className="text-xs text-slate-400">Nome</label><input required value={formData.name || ''} className="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white focus:border-orange-500 outline-none" onChange={e => setFormData({...formData, name: e.target.value})}/></div>
                                            <div><label className="text-xs text-slate-400">WhatsApp</label><input value={formData.whatsapp || ''} className="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white focus:border-orange-500 outline-none" onChange={e => setFormData({...formData, whatsapp: e.target.value})}/></div>
                                            <div><label className="text-xs text-slate-400">Vencimento</label><input type="date" required value={formData.dueDate || ''} className="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white focus:border-orange-500 outline-none" onChange={e => setFormData({...formData, dueDate: e.target.value})}/></div>
                                            <div><label className="text-xs text-slate-400">Usu√°rio IPTV</label><input value={formData.username || ''} className="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white focus:border-orange-500 outline-none" onChange={e => setFormData({...formData, username: e.target.value})}/></div>
                                            <div><label className="text-xs text-slate-400">Notas</label><textarea value={formData.notes || ''} className="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white focus:border-orange-500 outline-none" rows="2" onChange={e => setFormData({...formData, notes: e.target.value})}/></div>
                                        </>
                                    ) : (
                                        <>
                                            <div><label className="text-xs text-slate-400">Nome</label><input required value={formData.name || ''} className="w-full bg-slate-950 border border-slate-800 rounded p-2 text-white focus:border-orange-500 outline-none" onChange={e => setFormData({...formData, name: e.target.value})}/></div>
                                            <div><label className="text-xs text-slate-400">E-mail</label><input type="email" required value={formData.email || ''} disabled={!!editingItem} className={`w-full bg-slate-950 border border-slate-800 rounded p-2 text-white focus:border-orange-500 outline-none ${editingItem ? 'opacity-50 cursor-not-allowed' : ''}`} onChange={e => setFormData({...formData, email: e.target.value})}/></div>
                                            <div><label className="text-xs text-slate-400 font-bold text-orange-400">Cr√©ditos (Saldo)</label><input type="number" value={formData.credits || 0} className="w-full bg-slate-950 border border-orange-500/50 rounded p-2 text-white focus:border-orange-500 outline-none font-bold text-lg" onChange={e => setFormData({...formData, credits: e.target.value})}/></div>
                                        </>
                                    )}
                                    <button type="submit" className="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded transition-colors">{editingItem ? 'Salvar Altera√ß√µes' : 'Cadastrar'}</button>
                                </form>
                            </div>
                        </div>
                    )}
                  </main>
                </div>
              )}
            </>
          );
        }

        // Renderizar
        const root = createRoot(document.getElementById('root'));
        root.render(<FireTVManager />);
    </script>
</body>
</html>
